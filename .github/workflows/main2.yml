name: Manual Test Wish

on:
  workflow_dispatch:
    inputs:
      user_id:
        description: "Discord user ID to DM (test)"
        required: true
        type: string
      date_ist:
        description: "IST date to simulate (YYYY-MM-DD)"
        required: true
        default: "2026-01-01"
        type: string
      channel_id:
        description: "Optional channel ID override (blank = use DISCORD_FALLBACK_CHANNEL_ID)"
        required: false
        default: ""
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Send test wish (channel + DM)
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
        DISCORD_FALLBACK_CHANNEL_ID: ${{ secrets.DISCORD_FALLBACK_CHANNEL_ID }}
        DISCORD_STICKER_PREFIX: ${{ secrets.DISCORD_STICKER_PREFIX }}
        DISCORD_STICKER_PICK_MODE: ${{ secrets.DISCORD_STICKER_PICK_MODE }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_CALENDAR_IDS: ${{ secrets.GOOGLE_CALENDAR_IDS }}
        OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        OLLAMA_HOST: ${{ secrets.OLLAMA_HOST }}
        OLLAMA_MODEL: ${{ secrets.OLLAMA_MODEL }}
      run: |
        set -e
        echo "Testing date (IST): ${{ inputs.date_ist }}"
        if [ -n "${{ inputs.channel_id }}" ]; then
          echo "Sending channel test to override channel_id=${{ inputs.channel_id }}"
          python send_test_channel.py --date "${{ inputs.date_ist }}" --channel-id "${{ inputs.channel_id }}"
        else
          echo "Sending channel test to default DISCORD_FALLBACK_CHANNEL_ID"
          python send_test_channel.py --date "${{ inputs.date_ist }}"
        fi

        echo "Sending DM test to user_id=${{ inputs.user_id }}"
        python send_test_dm.py "${{ inputs.user_id }}" --date "${{ inputs.date_ist }}"
